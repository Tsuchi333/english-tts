<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英数字読み上げ v6</title>
    <style>
        body { font-family: sans-serif; padding: 15px; max-width: 500px; margin: auto; background-color: #f4f4f9; color: #333; }
        h2 { text-align: center; margin-bottom: 10px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; position: sticky; top: 0; background: #f4f4f9; padding: 10px 0; z-index: 100; }
        button { flex: 1; padding: 20px; font-size: 1.2rem; border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; }
        #btnSpeak { background-color: #4CAF50; }
        #btnStop { background-color: #f44336; }
        .config-box { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .category-container { background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); max-height: 300px; overflow-y: auto; }
        .category { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .category input { width: 25px; height: 25px; margin-right: 15px; }
        input[type="range"] { width: 100%; height: 30px; margin-top: 10px; cursor: pointer; }
        .highlight { background-color: #fff0f0; border-left: 5px solid #ff4444; font-weight: bold; color: #d32f2f; }
    </style>
</head>
<body>

    <h2>英数字読み上げ v6</h2>

    <div class="controls">
        <button id="btnSpeak">開始</button>
        <button id="btnStop" style="display:none;">停止</button>
    </div>

    <div class="config-box">
        <label id="status" style="color: #666;">カテゴリーを選んで開始を押してください</label>
    </div>

    <div class="config-box">
        <label><input type="radio" name="mode" id="rbLearn" checked> 学習（順番）</label>
        <span style="margin: 0 10px;">/</span>
        <label><input type="radio" name="mode" id="rbCheck"> テスト（ランダム）</label>
    </div>

    <div class="config-box">
        <label id="intervalLabel">読み上げ間隔：1秒</label>
        <input type="range" id="seekInterval" min="1" max="5" value="1">
    </div>

    <div id="categoryList" class="category-container">
        <label class="category highlight"><input type="checkbox" id="specialTeenTy"> 【特訓】teen vs ty (13-19、30-90)</label>
        <label class="category"><input type="checkbox" data-start="1" data-end="10"> 1～10</label>
        <label class="category"><input type="checkbox" data-start="10" data-end="15"> 10～15</label>
        <label class="category"><input type="checkbox" data-start="16" data-end="20"> 16～20</label>
        <label class="category"><input type="checkbox" data-start="20" data-end="30"> 20～30</label>
        <label class="category"><input type="checkbox" data-start="30" data-end="40"> 30～40</label>
        <label class="category"><input type="checkbox" data-start="40" data-end="50"> 40～50</label>
        <label class="category"><input type="checkbox" data-start="50" data-end="60"> 50～60</label>
        <label class="category"><input type="checkbox" data-start="60" data-end="70"> 60～70</label>
        <label class="category"><input type="checkbox" data-start="70" data-end="80"> 70～80</label>
        <label class="category"><input type="checkbox" data-start="80" data-end="90"> 80～90</label>
        <label class="category"><input type="checkbox" data-start="90" data-end="100"> 90～100</label>
    </div>

    <script>
        let queue = [];
        let index = 0;
        let isSpeaking = false;
        let nextTimeout = null;
        const synth = window.speechSynthesis;
        const seekInterval = document.getElementById('seekInterval');
        const intervalLabel = document.getElementById('intervalLabel');

        // スライダー表示の更新（リアルタイム）
        seekInterval.oninput = () => {
            intervalLabel.innerText = `読み上げ間隔：${seekInterval.value}秒`;
        };

        function speakNow(text) {
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'en-US';
            utter.rate = 0.9;

            utter.onend = () => {
                if (isSpeaking) {
                    // ここで現在のスライダーの秒数を取得してタイマーをセット
                    const currentSec = parseInt(seekInterval.value);
                    nextTimeout = setTimeout(speakNext, currentSec * 1000);
                }
            };
            synth.speak(utter);
        }

        function speakNext() {
            if (!isSpeaking) return;
            if (index >= queue.length) {
                stopAction();
                return;
            }
            speakNow(queue[index++].toString());
        }

        document.getElementById('btnSpeak').onclick = () => {
            const specialCheck = document.getElementById('specialTeenTy').checked;
            const normalChecks = Array.from(document.querySelectorAll('input[type="checkbox"]:not(#specialTeenTy):checked'));
            
            if (!specialCheck && normalChecks.length === 0) {
                alert("カテゴリーを選んでください");
                return;
            }

            isSpeaking = true;
            document.getElementById('btnSpeak').style.display = 'none';
            document.getElementById('btnStop').style.display = 'block';

            let pool = [];
            if (specialCheck) {
                pool = [13, 30, 14, 40, 15, 50, 16, 60, 17, 70, 18, 80, 19, 90];
            }
            normalChecks.forEach(cb => {
                const start = parseInt(cb.getAttribute('data-start'));
                const end = parseInt(cb.getAttribute('data-end'));
                for(let i = start; i <= end; i++) {
                    if (!pool.includes(i)) pool.push(i);
                }
            });

            if (document.getElementById('rbCheck').checked) {
                queue = pool.sort(() => Math.random() - 0.5);
            } else {
                queue = pool.sort((a, b) => a - b);
            }

            index = 0;
            speakNext();
        };

        function stopAction() {
            isSpeaking = false;
            clearTimeout(nextTimeout);
            synth.cancel();
            document.getElementById('btnSpeak').style.display = 'block';
            document.getElementById('btnStop').style.display = 'none';
        }

        document.getElementById('btnStop').onclick = stopAction;
        window.onbeforeunload = () => { synth.cancel(); };
    </script>
</body>
</html>